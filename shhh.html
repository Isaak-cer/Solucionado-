<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>shhh ‚Äî C√°mara web y compartir</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 1rem; color:#111; }
    .controls { margin-top:.6rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    button { padding:.6rem 1rem; font-size:1rem; }
    #video { max-width:100%; border-radius:8px; background:#000; }
    #photoPreview { display:block; max-width:100%; margin-top:.6rem; border-radius:8px; }
    .note { color:#555; margin-top:.6rem; }
  </style>
</head>
<body>
  <h1>shhh ‚Äî C√°mara</h1>
  <p>Pulsa <strong>Permitir</strong> cuando el navegador pregunte por la c√°mara. Si no aparece el permiso, comprueba que est√°s en HTTPS o en <code>localhost</code>.</p>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div class="controls">
    <button id="take">Tomar foto</button>
    <button id="switch" title="Cambiar c√°mara (si hay m√°s de una)">üîÅ Cambiar c√°mara</button>
    <button id="share" disabled>Compartir</button>
    <a id="download" style="display:inline-block; text-decoration:none; padding:.5rem .8rem; border:1px solid #ccc; border-radius:6px; color:inherit;">Descargar</a>
    <button id="openImage" disabled>Abrir imagen</button>
  </div>

  <img id="photoPreview" alt="Previsualizaci√≥n de la foto" />

  <p class="note" id="info">Estado: inicializando...</p>
  <p class="note">Con la verdad: la web solo puede usar la c√°mara si t√∫ lo permites. La imagen solo se comparte desde tu dispositivo cuando t√∫ lo decides.</p>

  <script>
  (function(){
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const takeBtn = document.getElementById('take');
    const shareBtn = document.getElementById('share');
    const downloadA = document.getElementById('download');
    const preview = document.getElementById('photoPreview');
    const info = document.getElementById('info');
    const switchBtn = document.getElementById('switch');
    const openImageBtn = document.getElementById('openImage');

    let currentStream = null;
    let currentDeviceId = null;
    let videoDevices = [];
    let lastBlob = null;

    async function listCameras(){
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        videoDevices = devices.filter(d => d.kind === 'videoinput');
      } catch(e){
        console.warn('No se pudieron listar dispositivos:', e);
      }
    }

    async function startCamera(deviceId = null){
      stopCamera();
      const constraints = {
        video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' },
        audio: false
      };
      try {
        info.textContent = 'Solicitando permiso de c√°mara...';
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        info.textContent = 'C√°mara activa.';
        // obtener deviceId actual si es posible
        await listCameras();
        if(videoDevices.length && !deviceId){
          // intentar inferir deviceId del stream
          const track = stream.getVideoTracks()[0];
          const settings = track.getSettings();
          if(settings && settings.deviceId) currentDeviceId = settings.deviceId;
        } else {
          currentDeviceId = deviceId;
        }
        // habilitar cambio si hay varias c√°maras
        switchBtn.disabled = (videoDevices.length < 2);
      } catch(err){
        console.error('Error al acceder a la c√°mara:', err);
        info.textContent = 'No se pudo acceder a la c√°mara. Comprueba permisos y que est√°s en HTTPS.';
      }
    }

    function stopCamera(){
      if(currentStream){
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
    }

    takeBtn.addEventListener('click', async () => {
      if(!currentStream){
        info.textContent = 'C√°mara no activa.';
        return;
      }
      // dibujar frame en canvas
      const width = video.videoWidth || 1280;
      const height = video.videoHeight || 720;
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      // convertir a blob
      canvas.toBlob(async (blob) => {
        if(!blob){ info.textContent = 'No se pudo generar la imagen.'; return; }
        lastBlob = blob;
        const url = URL.createObjectURL(blob);
        preview.src = url;
        preview.style.display = 'block';
        shareBtn.disabled = false;
        openImageBtn.disabled = false;

        // preparar enlace de descarga
        const filename = `foto_${Date.now()}.png`;
        downloadA.href = url;
        downloadA.download = filename;
        downloadA.textContent = 'Descargar';
        info.textContent = 'Foto tomada. Puedes compartirla o descargarla.';
      }, 'image/png');
    });

    // compartir
    shareBtn.addEventListener('click', async () => {
      if(!lastBlob){
        info.textContent = 'No hay foto para compartir.';
        return;
      }
      info.textContent = 'Preparando para compartir...';
      try {
        // Si el navegador soporta navigator.share con archivos
        if(navigator.canShare && navigator.canShare({ files: [new File([lastBlob], 'foto.png', { type: lastBlob.type })] }) ) {
          const file = new File([lastBlob], 'foto.png', { type: lastBlob.type });
          await navigator.share({
            files: [file],
            title: 'Mi foto',
            text: 'Te comparto esta foto desde la web'
          });
          info.textContent = 'Compartido.';
          return;
        }

        // Si tiene navigator.share pero no soporte de files (solo url/text)
        if(navigator.share){
          // crear URL temporal hacia la imagen
          const url = URL.createObjectURL(lastBlob);
          await navigator.share({
            title: 'Mi foto',
            text: 'Te comparto esta foto (abre el enlace)',
            url: url
          });
          // Nota: algunos sistemas ignorar√°n el url si no es https o no es accesible desde otros dispositivos.
          info.textContent = 'Intento de compartido con URL (si no funciona, descarga la imagen y comp√°rtela manualmente).';
          setTimeout(()=> URL.revokeObjectURL(url), 2000);
          return;
        }

        // Fallbacks: oferta de descarga y copiar al portapapeles si permite
        // Intentar copiar al portapapeles como blob -> requiere permiso y soporte (ClipboardItem)
        if(navigator.clipboard && window.ClipboardItem){
          try {
            const item = new ClipboardItem({ [lastBlob.type]: lastBlob });
            await navigator.clipboard.write([item]);
            info.textContent = 'Imagen copiada al portapapeles. P√©gala donde quieras.';
            return;
          } catch (err) {
            console.warn('No se pudo copiar al portapapeles:', err);
          }
        }

        // √∫ltimo recurso: abrir la imagen en nueva pesta√±a y sugerir descargar
        const url = URL.createObjectURL(lastBlob);
        window.open(url, '_blank');
        info.textContent = 'Abr√≠ la imagen en una pesta√±a nueva; usa "Guardar como" o descarga para compartir manualmente.';
        setTimeout(()=> URL.revokeObjectURL(url), 5000);
      } catch (err) {
        console.error('Error al intentar compartir:', err);
        info.textContent = 'Error compartiendo: ' + (err.message || err);
      }
    });

    // cambiar c√°mara (si hay m√°s de una)
    switchBtn.addEventListener('click', async () => {
      if(videoDevices.length < 2){ info.textContent = 'No hay m√°s c√°maras detectadas.'; return; }
      // encontrar √≠ndice actual
      let idx = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
      idx = (idx + 1) % videoDevices.length;
      const next = videoDevices[idx];
      if(next) {
        await startCamera(next.deviceId);
      } else {
        info.textContent = 'Imposible cambiar de c√°mara.';
      }
    });

    // abrir imagen en nueva pesta√±a
    openImageBtn.addEventListener('click', () => {
      if(!lastBlob) return;
      const url = URL.createObjectURL(lastBlob);
      window.open(url, '_blank');
      setTimeout(()=> URL.revokeObjectURL(url), 5000);
    });

    // iniciar
    (async function init(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        info.textContent = 'Tu navegador no soporta acceso a la c√°mara desde la web.';
        return;
      }
      await listCameras();
      await startCamera();
      info.textContent = 'Listo. Pulsa "Tomar foto".';
    })();

    // limpiar al salir
    window.addEventListener('beforeunload', () => stopCamera());
  })();
  </script>
</body>
</html>